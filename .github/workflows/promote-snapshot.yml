name: Promote Snapshot

on:
  workflow_dispatch:
    inputs:
      version:
        description: The SNAPSHOT to promote
        type: choice
        options:
          - 2.0.5-SNAPSHOT
          - 2.0.4-SNAPSHOT
          - 2.0.3-SNAPSHOT
          - 2.0.2-SNAPSHOT
          - 2.0.1-SNAPSHOT
          - 2.0.0-SNAPSHOT
          - 1.2.0-SNAPSHOT
          - 1.1.0-SNAPSHOT
          - 1.0.0-SNAPSHOT
          - 0.0.0

jobs:
  promote-release:
    runs-on: ubuntu-latest
    outputs:
      final-version: ${{ steps.version.outputs.final }}
    steps:

      # Create an assets folder
      - name: Create assets folder
        run: mkdir -p ./assets

      # Determine the new version tag
      - name: Set up final version
        id: version
        run: |
          SNAPSHOT="${{ github.event.inputs.version }}"
          FINAL="${SNAPSHOT/-SNAPSHOT/}"
          echo "FINAL_VERSION=$FINAL" >> $GITHUB_ENV
          echo "Promoting $SNAPSHOT → $FINAL"
          echo "final=$FINAL" >> $GITHUB_OUTPUT

      # Download assets from the SNAPSHOT release
      - name: Download SNAPSHOT release assets
        id: snapshot_release
        uses: KevinRohn/github-full-release-data@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ github.event.inputs.version }}
          asset-file: '*.jar'
          asset-output: './assets'

      # Prepare release body with updated version
      - name: Prepare release body
        run: |
          echo "${{ fromJSON(steps.snapshot_release.outputs.body) }}" > original_body.md

      # Rewrite the release heading
      - name: Rewrite release heading
        run: |
          SNAPSHOT="${{ github.event.inputs.version }}"
          FINAL="${SNAPSHOT/-SNAPSHOT/}"

          REPO_OWNER="${GITHUB_REPOSITORY%/*}"
          REPO_NAME="${GITHUB_REPOSITORY#*/}"

          # Match heading with date at the end: (...SNAPSHOT)
          sed -E \
            "0,/^## \\[$SNAPSHOT\\]\\(https:\/\/github.com\/${REPO_OWNER}\/${REPO_NAME}\/compare\/([^)]*)$SNAPSHOT\) \([0-9]{4}-[0-9]{2}-[0-9]{2}\)/s/^## \\[$SNAPSHOT\\]\\(https:\/\/github.com\/${REPO_OWNER}\/${REPO_NAME}\/compare\/([^)]*)$SNAPSHOT\) \(([0-9]{4}-[0-9]{2}-[0-9]{2})\)/## [$FINAL](https:\/\/github.com\/${REPO_OWNER}\/${REPO_NAME}\/compare\/\1$FINAL) (\2)/" \
            original_body.md \
            > updated_body.md

          echo "RELEASE_BODY<<EOF" >> $GITHUB_ENV
          cat updated_body.md >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # Rename downloaded JAR assets
      - name: Rename assets to final version
        run: |
          FINAL="${{ env.FINAL_VERSION }}"
          for file in ./assets/*.jar; do
            NEWNAME="$(echo "$(basename "$file")" | sed "s/-SNAPSHOT//")"
            mv "$file" "./assets/$NEWNAME"
            echo "Renamed: $file → $NEWNAME"
          done

      # Create the new release using the body from the SNAPSHOT release
      - name: Create promoted release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.FINAL_VERSION }}
          tag_name: ${{ env.FINAL_VERSION }}
          body: ${{ env.RELEASE_BODY }}
          files: ./assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.CI_CD_PAT }}

  # Add the promoted version as an option in Deploy
  update-deploy-options:
    needs: promote-release
    uses: ./.github/workflows/update-version.yml
    with:
      workflow-file: .github/workflows/deploy.yml
      version: ${{ needs.promote-release.outputs.final-version }}
    secrets:
      TOKEN: ${{ secrets.CI_CD_PAT }}
