name: Promote Snapshot

on:
  workflow_dispatch:
    inputs:
      version:
        description: The SNAPSHOT to promote
        type: choice
        options:
          - 0.0.0

jobs:
  promote-release:
    runs-on: ubuntu-latest
    steps:

      # Create an assets folder
      - name: Create assets folder
        run: mkdir -p ./assets

      # Determine the new version tag
      - name: Set up final version
        id: version
        run: |
          SNAPSHOT="${{ github.event.inputs.version }}"
          FINAL="${SNAPSHOT/-SNAPSHOT/}"
          echo "FINAL_VERSION=$FINAL" >> $GITHUB_ENV
          echo "Promoting $SNAPSHOT â†’ $FINAL"

      # Download assets from the SNAPSHOT release
      - name: Download SNAPSHOT release assets
        id: snapshot_release
        uses: KevinRohn/github-full-release-data@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ github.event.inputs.version }}
          asset-file: '*.jar'
          asset-output: './assets'

      # Create the new release using the body from the SNAPSHOT release
      - name: Create promoted release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ env.FINAL_VERSION }}
          tag_name: ${{ env.FINAL_VERSION }}
          body: ${{ fromJSON(steps.snapshot_release.outputs.body) }}
          files: ./assets/*
        env:
          GITHUB_TOKEN: ${{ secrets.CI_CD_PAT }}

  update-deploy-options:
    needs: promote-release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      # Add the new version as an option in deploy.yml
      - name: Update deploy workflow options
        run: |
          FILE=".github/workflows/deploy.yml"
          VERSION="${{ needs.promote-release.outputs.final_version }}"
          
          sed -i "/- $VERSION/d" "$FILE"
          sed -i "/options:/a\          - $VERSION" "$FILE"
          - 1.0.0-SNAPSHOT

      # Commit and push changes
      - name: Commit and push changes
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git remote set-url origin https://x-access-token:${{ secrets.CI_CD_PAT }}@github.com/${{ github.repository }}.git
          
          if git diff --quiet $FILE; then
            echo "No changes to commit"
            exit 0
          fi
          
          git add $FILE
          git commit -m "Release ${{ inputs.version }} [skip ci]"
          git push
